<?xml version="1.0" encoding="UTF-8"?>
<jube>
  <benchmark name="hello" outpath="run_all_reduced">
    <comment>psmgmt-5.1.61-0 </comment>

    <parameterset name="compile_param">
      <!--<parameter name="system" type="string" tag="jr">jr</parameter>-->
      <!--<parameter name="system" type="string" tag="jrt">jrt</parameter>-->
      <!--<parameter name="system" type="string" tag="jw">jw</parameter>-->
      <!--<parameter name="system" type="string" tag="jwt">jwt</parameter>-->
      <!--<parameter name="system" type="string" tag="jwb">jwb</parameter>-->
      <parameter name="system" type="string" tag="js">js</parameter>

      <parameter name="load_modules" type="string" tag="ip">ml Intel ParaStationMPI</parameter>
      <parameter name="load_modules" type="string" tag="ii">ml Intel IntelMPI</parameter>
      <parameter name="load_modules" type="string" tag="gp">ml GCC ParaStationMPI</parameter>
      
      <parameter name="source_dir" type="string">${jube_benchmark_home}</parameter>
      <parameter name="source_file" type="string">all_hello_world_mask.cpp</parameter>
      <parameter name="exe_file" type="string">hello_world.exe</parameter>
    </parameterset>

    <!-- copy source code into the sandbox directory -->
    <fileset name="source_code">
      <copy>${source_dir}/${source_file}</copy>
    </fileset>

    <!-- load modules used for compilation and compile the source code in the sandbox directory -->
    <step name="compile">
      <use>source_code</use>
      <use>compile_param</use>
      <do>${load_modules}</do>
      <do tag="ip|ii">mpicxx -qopenmp ${source_file} -o ${exe_file}</do>
      <do tag="gp">mpicxx -fopenmp ${source_file} -o ${exe_file}</do>
    </step>

    <!--
      0-3: Pure OpenMP without SMT
      4-7: Pure OpenMP with SMT
      8-9: Hybrid with odd number of threads (w and w/o SMT)
      10-11: Hybrid with even number of threads (w and w/o SMT) (Tasks*Threads=physic.Cores)
      12-19: Pure MPI (w and w/o SMT); 14-17: Check pinning rule change
    -->
    <!-- initial paramterset with corresponding set in $JUBE_INCLUDE_PATH/platform.xml -->
    <parameterset name="systemParameter" init_with="platform.xml">
      <parameter name="nodes" type="int">1</parameter>
      <parameter name="i" type="int" mode="python">",".join([str(i) for i in range(0,1)])</parameter>
      <parameter name="tasks" type="int" mode="python">
        {"js" : [ 1, 1, 1, 1, 1, 1, 1, 1, 16, 16, 16, 16, 64, 64, 127, 127, 128, 128, 192, 256][$i]}.get("${system}",0)
      </parameter>
      <parameter name="threadspertask" type="int" mode="python">
        {"js" : [ 32, 64, 96, 128, 64, 128, 192, 256, 3, 3, 8, 8, 1, 1, 1, 1, 1, 1, 1, 1][$i]}.get("${system}",0)
      </parameter>

      <parameter name="executable">./compile/${exe_file}</parameter>
      <parameter name="args_exec">${system}</parameter>
      <parameter name="timelimit">00:02:00</parameter>
      <parameter name="env">${load_modules}</parameter>
      <parameter name="measurement">time -p</parameter>
      <parameter name="queue">batch</parameter> <!-- maint -A root-->
      <parameter name="account">cstao</parameter> <!-- root, cstao -->
      <parameter name="additional_job_config">#SBATCH --threads-per-core=${tpc}</parameter>

      <parameter name="filename">
        ${system}-${nodes}-${tasks}-${threadspertask}-${tpc}-${cpubind}-${node_dist}-${socket_dist}-${core_dist}
      </parameter>
      <parameter name="outlogfile">${filename}.out</parameter>
      <parameter name="errlogfile">${filename}.err</parameter>
    </parameterset>

    <parameterset name="executeset" init_with="platform.xml">
      <parameter name="cpubind" tag="threads">threads</parameter>
      <parameter name="cpubind" tag="rank">rank</parameter>
      <parameter name="cpubind" tag="rank_ldom">rank_ldom</parameter>
      <parameter name="cpubind" tag="cores">cores</parameter>
      <parameter name="cpubind" tag="cb_all">threads,rank,rank_ldom,cores</parameter>
      <parameter name="cpubind_arg" mode="python" separator="%">
        "--cpu-bind=v,${cpubind}" if "${cpubind}" != "" else ""
      </parameter>

      <parameter name="node_dist">block</parameter>
      <parameter name="socket_dist">cyclic</parameter>
      <parameter name="core_dist" tag="cyclic">cyclic</parameter>
      <parameter name="core_dist" tag="fcyclic">fcyclic</parameter>
      <parameter name="core_dist" tag="cd_all">cyclic,fcyclic</parameter>
      <parameter name="distribution">${node_dist}:${socket_dist}:${core_dist}</parameter>
      <parameter name="distribution_arg" mode="python" separator="%">
        "--distribution=${distribution}" if "${distribution}" != "" else ""
      </parameter>

      <parameter name="tpc" type="int" mode="python">
        {"js" : [ 1, 1, 1,  1, 2,  2,  2,  2, 1, 2, 1, 2, 1, 2,  1,  2,  1,  2,  2,  2][$i]}.get("${system}",0)
      </parameter>
      <parameter name="tpc_arg">--threads-per-core=${tpc}</parameter>

      <parameter name="verbose"></parameter>
      <parameter name="verbose" tag="verbose">--verbose</parameter>

      <parameter name="args_starter" separator="%">
        ${verbose} ${tpc_arg} ${cpubind_arg} ${distribution_arg}
      </parameter>
    </parameterset>


    <!-- substitute pattern in submit script-->
    <substituteset name="executesub" init_with="platform.xml">
      <sub source="#ENV#" tag="ii" separator="|">
        export OMP_NUM_THREADS=$${SLURM_CPUS_PER_TASK}
        export OMP_PLACES=threads OMP_PROC_BIND=close
        export SRUN_CPUS_PER_TASK=${SLURM_CPUS_PER_TASK}
        export PSSLURM_PRINT_COREMAPS=1
        $env
      </sub>
      <sub source="#ENV#" tag="ip|gp" separator="|">
        export OMP_NUM_THREADS=$${SLURM_CPUS_PER_TASK}
        export OMP_PLACES=threads OMP_PROC_BIND=close
        export SRUN_CPUS_PER_TASK=${SLURM_CPUS_PER_TASK}
        export PSSLURM_PRINT_COREMAPS=1
        #export PSP_ONDEMAND=1
        ${env}
      </sub>
      <sub source="#MEASUREMENT#" dest="$measurement"/>
    </substituteset>

    
    <!-- prepare submit script and submit the job to the batch system-->
    <step name="exe" suffix="${nodes}-${tasks}-${threadspertask}-${tpc}-${cpubind}-${node_dist}-${socket_dist}-${core_dist}" depend="compile" procs="12">
      <use>systemParameter</use>            
      <!-- <use from="platform.xml">executeset</use> -->
      <use>executeset</use>
      <use>executesub</use>
      <use from="platform.xml">jobfiles</use>
      <do done_file="$done_file">${submit} ${submit_script}</do>
      <do>mkdir -p ${jube_benchmark_home}/pin_logs/</do>
      <do>cp ${outlogfile} ${jube_benchmark_home}/pin_logs/</do>
    </step>    

    <!-- pattern to extract time measurement -->
    <patternset name="runtime_pat">
      <pattern mode="pattern" name="runtime" unit="sec" type="float">real ${jube_pat_fp}</pattern>
    </patternset>

    <patternset name="out_pat">
      <pattern mode="pattern" name="begintime" unit="sec" type="float">begin time = ${jube_pat_fp}</pattern>
      <pattern mode="pattern" name="inittime" unit="sec" type="float">init time = ${jube_pat_fp}</pattern>
      <pattern name="initstart" unit="sec" type="float">initStart = ${jube_pat_fp} s</pattern>
      <pattern name="endtime" unit="sec" type="float">initEnd = ${jube_pat_fp} s</pattern>
      <pattern mode="pattern" name="totaltime" unit="sec" type="float">total time = ${jube_pat_fp}</pattern>
      <pattern mode="pattern" name="internaltime" type="float">internalTime = ${jube_pat_fp} s</pattern>

<!--      <pattern mode="python" name="tot_time" unit="sec" type="float">${totaltime}-${begintime_min}</pattern> -->
<!--      <pattern mode="pattern" name="rankid" type="int">rankend = ${jube_pat_int} before MPI_Finalize</pattern> -->
    </patternset>

    <patternset name="status_pat">
      <pattern name="job_id" type="int">Submitted batch job $jube_pat_int</pattern>
      <pattern name="status" mode="perl">'`sacct --format State -j $job_id | head -n 3 | tail -n 1`'</pattern>
      <pattern name="exit_code" mode="perl">'`sacct --format ExitCode -j $job_id | head -n 3 | tail -n 1`'</pattern>
    </patternset>

    <!-- analyse the file ${errlogfile} in the sandbox directory of step named 'exe'-->
    <analyser name="analyse_time" reduce="false">
      <use>runtime_pat</use>
      <analyse step="exe">
        <file>${errlogfile}</file>
        <file use="out_pat">${outlogfile}</file>
        <file use="status_pat">stdout</file>
      </analyse>
    </analyser>

    <!-- create a result table-->
    <result>
      <use>analyse_time</use>
      <table name="res" style="pretty">
        <column>system</column>
        <column>nodes</column>
        <column>tasks</column>
        <column title="tpt">threadspertask</column>
        <column>tpc</column>
        <column>cpubind</column>
        <column title="dist">distribution</column>
        <column>runtime</column> 
        <column>status</column>
        <column>exit_code</column>
      </table>
    </result>
    
  </benchmark>
</jube>
